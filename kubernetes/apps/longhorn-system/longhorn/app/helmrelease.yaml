---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: longhorn
spec:
  chart:
    spec:
      chart: longhorn
      version: 1.10.1
      sourceRef:
        kind: HelmRepository
        name: longhorn
  interval: 1h
  values:
    # Use hotfix image for 1.10.1
    image:
      longhorn:
        manager:
          repository: longhornio/longhorn-manager
          tag: v1.10.1-hotfix-2

    persistence:
      defaultClass: true
      # TODO: Increase to 3 when additional worker nodes are added
      defaultClassReplicaCount: 1  # Start with 1, increase as nodes are added
      reclaimPolicy: Retain
      # TODO: Enable when additional worker nodes are added for zero-downtime node maintenance
      # migratable: true

    defaultSettings:
      createDefaultDiskLabeledNodes: true
      defaultDataLocality: best-effort
      nodeDownPodDeletionPolicy: delete-both-statefulset-and-deployment-pod
      nodeDrainPolicy: block-if-contains-last-replica
      concurrentAutomaticEngineUpgradePerNodeLimit: 1
      defaultDataPath: /var/mnt/longhorn
      # TODO: Increase to 3 when additional worker nodes are added
      defaultReplicaCount: '{"v1":"1","v2":"1"}'  # Start with 1, increase as nodes are added
      # TODO: Change to false when additional worker nodes are added
      replicaSoftAntiAffinity: true  # Allow replicas on same node (needed for single node)
      # TODO: Add replicaAutoBalance: best-effort when additional worker nodes are added
      restoreVolumeRecurringJobs: true
      storageMinimalAvailablePercentage: 10
      storageReservedPercentageForDefaultDisk: 10
      snapshotDataIntegrity: fast-check
      snapshotDataIntegrityImmediateCheckAfterSnapshotCreation: true
      snapshotDataIntegrityCronjob: "0 1 * * 0"  # 1 AM every Sunday, well before morning backup jobs
      removeSnapshotsDuringFilesystemTrim: true
      fastReplicaRebuildEnabled: true
      allowCollectingLonghornUsageMetrics: false

    # Backup target configuration
    defaultBackupStore:
      backupTarget: nfs://${RACKNAS_ADDR}:/volume1/LonghornBackupstore
      pollInterval: 300

    # Webhook configuration - adjust replicas as needed
    longhornConversionWebhook:
      replicas: 0
    longhornAdmissionWebhook:
      replicas: 0
    longhornRecoveryBackend:
      replicas: 0

    # Disable built-in ingress - using Envoy Gateway HTTPRoute instead
    ingress:
      enabled: false

    # Deploy HTTPRoute via extraObjects
    extraObjects:
      - apiVersion: gateway.networking.k8s.io/v1
        kind: HTTPRoute
        metadata:
          name: longhorn
          namespace: longhorn-system
        spec:
          hostnames:
            - longhorn.${SECRET_DOMAIN}
          parentRefs:
            - name: envoy-internal
              namespace: gateway
              sectionName: https
          rules:
            - backendRefs:
                - name: longhorn-frontend
                  port: 80
