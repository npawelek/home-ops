---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: longhorn
spec:
  chart:
    spec:
      chart: longhorn
      version: 1.11.0
      sourceRef:
        kind: HelmRepository
        name: longhorn
  interval: 1h
  values:
    persistence:
      defaultClass: true
      defaultClassReplicaCount: 3
      reclaimPolicy: Retain
      replicaSoftAntiAffinity: true
      replicaAutoBalance: best-effort
      dataLocality: best-effort
      migratable: true
      recurringJobSelector:
        enable: true
        jobList: '[{"name":"backup-24h","isGroup":true},{"name":"default","isGroup":true}]'

    defaultSettings:
      createDefaultDiskLabeledNodes: true
      defaultDataLocality: best-effort
      nodeDownPodDeletionPolicy: delete-both-statefulset-and-deployment-pod
      nodeDrainPolicy: block-if-contains-last-replica
      concurrentAutomaticEngineUpgradePerNodeLimit: 1
      defaultDataPath: /var/mnt/longhorn
      defaultReplicaCount: 3
      replicaSoftAntiAffinity: false
      replicaAutoBalance: best-effort
      restoreVolumeRecurringJobs: true
      storageMinimalAvailablePercentage: 10
      storageReservedPercentageForDefaultDisk: 10
      snapshotDataIntegrity: fast-check
      snapshotDataIntegrityImmediateCheckAfterSnapshotCreation: true
      snapshotDataIntegrityCronjob: "0 1 * * 0"  # 1 AM every Sunday, well before morning backup jobs
      removeSnapshotsDuringFilesystemTrim: true
      fastReplicaRebuildEnabled: true
      allowCollectingLonghornUsageMetrics: false

    # Backup target configuration
    defaultBackupStore:
      backupTarget: nfs://${RACKNAS_ADDR}:/volume1/LonghornBackupstore
      pollInterval: 300

    # Webhook configuration - adjust replicas as needed
    longhornConversionWebhook:
      replicas: 0
    longhornAdmissionWebhook:
      replicas: 0
    longhornRecoveryBackend:
      replicas: 0

    # Disable built-in ingress - using Envoy Gateway HTTPRoute instead
    ingress:
      enabled: false

    # Deploy HTTPRoute via extraObjects
    extraObjects:
      - apiVersion: gateway.networking.k8s.io/v1
        kind: HTTPRoute
        metadata:
          name: longhorn
          namespace: longhorn-system
        spec:
          hostnames:
            - longhorn.${SECRET_DOMAIN}
          parentRefs:
            - name: envoy-internal
              namespace: gateway
              sectionName: https
          rules:
            - backendRefs:
                - name: longhorn-frontend
                  port: 80
