---
version: '3'

set: [pipefail]
shopt: [globstar]

vars:
  BOOTSTRAP_DIR: '{{.ROOT_DIR}}/bootstrap'
  KUBERNETES_DIR: '{{.ROOT_DIR}}/kubernetes'
  SCRIPTS_DIR: '{{.ROOT_DIR}}/scripts'
  TALOS_DIR: '{{.ROOT_DIR}}/talos'
  PRIVATE_DIR: '{{.ROOT_DIR}}/.private'
  TALOSCONFIG: '{{.ROOT_DIR}}/talos/clusterconfig/talosconfig'
  IPXE_DIR: '{{.ROOT_DIR}}/ipxe'

env:
  KUBECONFIG: '{{.ROOT_DIR}}/kubeconfig'
  SOPS_AGE_KEY_FILE: '{{.ROOT_DIR}}/age.key'
  TALOSCONFIG: '{{.TALOSCONFIG}}'

includes:
  bootstrap: .taskfiles/bootstrap
  ipxe: .taskfiles/ipxe
  talos: .taskfiles/talos

tasks:

  default: task --list

  validate:
    desc: Validate Kubernetes manifests with flux-local
    cmd: flux-local test --enable-helm --all-namespaces --path {{.KUBERNETES_DIR}}/flux/cluster -v
    preconditions:
      - which flux-local

  reconcile:
    desc: Force Flux to pull in changes from your Git repository
    cmd: flux --namespace flux-system reconcile kustomization flux-system --with-source
    preconditions:
      - test -f {{.KUBECONFIG}}
      - which flux

  tf-reconcile:
    desc: Request Terraform controller to reconcile (graceful)
    cmd: kubectl annotate terraform authentik -n auth reconcile.fluxcd.io/requestedAt="$(date +%s)" --overwrite
    preconditions:
      - test -f {{.KUBECONFIG}}
      - which kubectl
      - kubectl get terraform authentik -n auth &>/dev/null || (echo "Terraform resource 'authentik' not found in namespace 'auth'" && exit 1)

  tf-force:
    desc: Force Terraform controller to reconcile (suspend/resume)
    cmd: kubectl patch terraform authentik -n auth -p '{"spec":{"suspend":true}}' --type=merge && sleep 2 && kubectl patch terraform authentik -n auth -p '{"spec":{"suspend":false}}' --type=merge
    preconditions:
      - test -f {{.KUBECONFIG}}
      - which kubectl
      - kubectl get terraform authentik -n auth &>/dev/null || (echo "Terraform resource 'authentik' not found in namespace 'auth'" && exit 1)
